-- ============================================================================
-- Migraci√≥n: Actualizar funci√≥n template para incluir subcategor√≠a Alquiler
-- Fecha: 2025-10-31 03:15:21
-- Descripci√≥n: Agrega "Alquiler" a la subcategor√≠a de Vivienda en el template
--              para que todos los nuevos hogares la tengan autom√°ticamente
-- ============================================================================

SET ROLE cuentassik_prod_owner;

-- Recrear la funci√≥n con Alquiler incluido
CREATE OR REPLACE FUNCTION public.create_default_household_categories()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  -- Parent variables
  v_parent_hogar UUID;
  v_parent_suministros UUID;
  v_parent_alimentacion UUID;
  v_parent_transporte UUID;
  v_parent_personal UUID;
  v_parent_estilo_vida UUID;
  v_parent_finanzas UUID;
  v_parent_ingresos_laborales UUID;
  v_parent_otros_ingresos UUID;

  -- Category variables (37 total)
  v_cat_vivienda UUID;
  v_cat_menaje UUID;
  v_cat_limpieza UUID;
  v_cat_mantenimiento UUID;
  v_cat_comunidad UUID;
  v_cat_lavanderia UUID;
  v_cat_luz UUID;
  v_cat_agua UUID;
  v_cat_gas UUID;
  v_cat_internet UUID;
  v_cat_telefono UUID;
  v_cat_seguros UUID;
  v_cat_impuestos UUID;
  v_cat_supermercado UUID;
  v_cat_carniceria UUID;
  v_cat_pescaderia UUID;
  v_cat_fruteria UUID;
  v_cat_panaderia UUID;
  v_cat_otros_alimentos UUID;
  v_cat_restaurantes UUID;
  v_cat_transporte UUID;
  v_cat_combustible UUID;
  v_cat_parking UUID;
  v_cat_peajes UUID;
  v_cat_salud UUID;
  v_cat_farmacia UUID;
  v_cat_gimnasio UUID;
  v_cat_belleza UUID;
  v_cat_ropa UUID;
  v_cat_calzado UUID;
  v_cat_mascotas UUID;
  v_cat_educacion UUID;
  v_cat_ocio UUID;
  v_cat_varios_exp UUID;
  v_cat_nomina UUID;
  v_cat_freelance UUID;
  v_cat_devoluciones UUID;
  v_cat_aportacion UUID;
  v_cat_varios_ing UUID;
  v_cat_pago_prestamo UUID;
BEGIN
  -- ============================================================================
  -- CATEGORY PARENTS (9 total)
  -- ============================================================================

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Hogar', 'üè†', 'expense', 1)
  RETURNING id INTO v_parent_hogar;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Suministros', '‚ö°', 'expense', 2)
  RETURNING id INTO v_parent_suministros;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Alimentaci√≥n', 'üçΩÔ∏è', 'expense', 3)
  RETURNING id INTO v_parent_alimentacion;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Transporte', 'üöó', 'expense', 4)
  RETURNING id INTO v_parent_transporte;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Personal', 'üë§', 'expense', 5)
  RETURNING id INTO v_parent_personal;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Estilo de vida', 'üé®', 'expense', 6)
  RETURNING id INTO v_parent_estilo_vida;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Finanzas', 'üí∞', 'expense', 7)
  RETURNING id INTO v_parent_finanzas;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Ingresos Laborales', 'üíº', 'income', 8)
  RETURNING id INTO v_parent_ingresos_laborales;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Otros Ingresos', 'üí∏', 'income', 9)
  RETURNING id INTO v_parent_otros_ingresos;

  -- ============================================================================
  -- CATEGORIES (37 total)
  -- ============================================================================

  -- HOGAR (6 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Vivienda', 'üè†', 'expense', v_parent_hogar, 1)
  RETURNING id INTO v_cat_vivienda;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Menaje', 'ü™ë', 'expense', v_parent_hogar, 2)
  RETURNING id INTO v_cat_menaje;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Limpieza', 'üßπ', 'expense', v_parent_hogar, 3)
  RETURNING id INTO v_cat_limpieza;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Mantenimiento', 'üîß', 'expense', v_parent_hogar, 4)
  RETURNING id INTO v_cat_mantenimiento;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Comunidad', 'üè¢', 'expense', v_parent_hogar, 5)
  RETURNING id INTO v_cat_comunidad;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Lavander√≠a', 'üß∫', 'expense', v_parent_hogar, 6)
  RETURNING id INTO v_cat_lavanderia;

  -- SUMINISTROS (5 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Luz', 'üí°', 'expense', v_parent_suministros, 1)
  RETURNING id INTO v_cat_luz;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Agua', 'üíß', 'expense', v_parent_suministros, 2)
  RETURNING id INTO v_cat_agua;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Gas/Butano', 'üî•', 'expense', v_parent_suministros, 3)
  RETURNING id INTO v_cat_gas;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Internet', 'üåê', 'expense', v_parent_suministros, 4)
  RETURNING id INTO v_cat_internet;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Tel√©fono', 'üì±', 'expense', v_parent_suministros, 5)
  RETURNING id INTO v_cat_telefono;

  -- SUMINISTROS - Otros (2 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Seguros', 'üõ°Ô∏è', 'expense', v_parent_suministros, 6)
  RETURNING id INTO v_cat_seguros;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Impuestos', 'üìã', 'expense', v_parent_suministros, 7)
  RETURNING id INTO v_cat_impuestos;

  -- ALIMENTACI√ìN (7 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Supermercado', 'üõí', 'expense', v_parent_alimentacion, 1)
  RETURNING id INTO v_cat_supermercado;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Carnicer√≠a', 'ü•©', 'expense', v_parent_alimentacion, 2)
  RETURNING id INTO v_cat_carniceria;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Pescader√≠a', 'üêü', 'expense', v_parent_alimentacion, 3)
  RETURNING id INTO v_cat_pescaderia;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Fruter√≠a', 'üçé', 'expense', v_parent_alimentacion, 4)
  RETURNING id INTO v_cat_fruteria;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Panader√≠a', 'ü•ñ', 'expense', v_parent_alimentacion, 5)
  RETURNING id INTO v_cat_panaderia;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Otros Alimentos', 'üç±', 'expense', v_parent_alimentacion, 6)
  RETURNING id INTO v_cat_otros_alimentos;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Restaurantes', 'üçΩÔ∏è', 'expense', v_parent_alimentacion, 7)
  RETURNING id INTO v_cat_restaurantes;

  -- TRANSPORTE (4 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Transporte', 'üöó', 'expense', v_parent_transporte, 1)
  RETURNING id INTO v_cat_transporte;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Combustible', '‚õΩ', 'expense', v_parent_transporte, 2)
  RETURNING id INTO v_cat_combustible;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Parking', 'üÖøÔ∏è', 'expense', v_parent_transporte, 3)
  RETURNING id INTO v_cat_parking;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Peajes', 'üõ£Ô∏è', 'expense', v_parent_transporte, 4)
  RETURNING id INTO v_cat_peajes;

  -- PERSONAL (4 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Salud', 'üè•', 'expense', v_parent_personal, 1)
  RETURNING id INTO v_cat_salud;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Farmacia', 'üíä', 'expense', v_parent_personal, 2)
  RETURNING id INTO v_cat_farmacia;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Gimnasio', 'üèãÔ∏è', 'expense', v_parent_personal, 3)
  RETURNING id INTO v_cat_gimnasio;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Belleza', 'üíÑ', 'expense', v_parent_personal, 4)
  RETURNING id INTO v_cat_belleza;

  -- ESTILO DE VIDA (4 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Ropa', 'üëï', 'expense', v_parent_estilo_vida, 1)
  RETURNING id INTO v_cat_ropa;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Calzado', 'üëû', 'expense', v_parent_estilo_vida, 2)
  RETURNING id INTO v_cat_calzado;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Mascotas', 'üê∂', 'expense', v_parent_estilo_vida, 3)
  RETURNING id INTO v_cat_mascotas;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Educaci√≥n', 'üìö', 'expense', v_parent_estilo_vida, 4)
  RETURNING id INTO v_cat_educacion;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Ocio', 'üé≠', 'expense', v_parent_estilo_vida, 5)
  RETURNING id INTO v_cat_ocio;

  -- FINANZAS (1 categor√≠a)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Varios', 'üìã', 'expense', v_parent_finanzas, 1)
  RETURNING id INTO v_cat_varios_exp;

  -- INGRESOS LABORALES (2 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'N√≥mina', 'üí∞', 'income', v_parent_ingresos_laborales, 1)
  RETURNING id INTO v_cat_nomina;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Freelance', 'üíº', 'income', v_parent_ingresos_laborales, 2)
  RETURNING id INTO v_cat_freelance;

  -- OTROS INGRESOS (5 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Devoluciones', 'üîÑ', 'income', v_parent_otros_ingresos, 3)
  RETURNING id INTO v_cat_devoluciones;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Aportaci√≥n Cuenta Conjunta', 'üè¶', 'income', v_parent_otros_ingresos, 4)
  RETURNING id INTO v_cat_aportacion;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Varios', 'üìã', 'income', v_parent_otros_ingresos, 5)
  RETURNING id INTO v_cat_varios_ing;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Pago Pr√©stamo', 'üí≥', 'income', v_parent_otros_ingresos, 6)
  RETURNING id INTO v_cat_pago_prestamo;

  -- ============================================================================
  -- SUBCATEGOR√çAS (51 total - ACTUALIZADO CON ALQUILER)
  -- ============================================================================

  -- ‚ú® NUEVA: Vivienda (1 subcategor√≠a)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_vivienda, 'Alquiler', 'üè†', 1);

  -- Supermercado (7 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_supermercado, 'Mercadona', 'üõí', 1),
    (v_cat_supermercado, 'Lidl', 'üõí', 2),
    (v_cat_supermercado, 'Carrefour', 'üõí', 3),
    (v_cat_supermercado, 'D√≠a', 'üõí', 4),
    (v_cat_supermercado, 'Alcampo', 'üõí', 5),
    (v_cat_supermercado, 'Eroski', 'üõí', 6),
    (v_cat_supermercado, 'Otro supermercado', 'üõí', 7);

  -- Restaurantes (6 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_restaurantes, 'Fast Food', 'üçî', 1),
    (v_cat_restaurantes, 'Cafeter√≠as', '‚òï', 2),
    (v_cat_restaurantes, 'Restaurante Casual', 'üçΩÔ∏è', 3),
    (v_cat_restaurantes, 'Restaurante Medio', 'üçΩÔ∏è', 4),
    (v_cat_restaurantes, 'Delivery', 'üõµ', 5),
    (v_cat_restaurantes, 'Otro restaurante', 'üçΩÔ∏è', 6);

  -- Luz (5 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_luz, 'Iberdrola', 'üí°', 1),
    (v_cat_luz, 'Endesa', 'üí°', 2),
    (v_cat_luz, 'Naturgy', 'üí°', 3),
    (v_cat_luz, 'Repsol', 'üí°', 4),
    (v_cat_luz, 'Otra compa√±√≠a', 'üí°', 5);

  -- Agua (3 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_agua, 'Canal de Isabel II', 'üíß', 1),
    (v_cat_agua, 'Aguas Municipales', 'üíß', 2),
    (v_cat_agua, 'Otra compa√±√≠a', 'üíß', 3);

  -- Gas/Butano (3 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_gas, 'Naturgy', 'üî•', 1),
    (v_cat_gas, 'Repsol Butano', 'üî•', 2),
    (v_cat_gas, 'Otra compa√±√≠a', 'üî•', 3);

  -- Internet (6 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_internet, 'Vodafone', 'üåê', 1),
    (v_cat_internet, 'Movistar', 'üåê', 2),
    (v_cat_internet, 'Orange', 'üåê', 3),
    (v_cat_internet, 'Yoigo', 'üåê', 4),
    (v_cat_internet, 'M√°sM√≥vil', 'üåê', 5),
    (v_cat_internet, 'Otra operadora', 'üåê', 6);

  -- Tel√©fono (5 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_telefono, 'Vodafone', 'üì±', 1),
    (v_cat_telefono, 'Movistar', 'üì±', 2),
    (v_cat_telefono, 'Orange', 'üì±', 3),
    (v_cat_telefono, 'Yoigo', 'üì±', 4),
    (v_cat_telefono, 'Otra operadora', 'üì±', 5);

  -- Transporte (12 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_transporte, 'Gasolina', '‚õΩ', 1),
    (v_cat_transporte, 'Di√©sel', '‚õΩ', 2),
    (v_cat_transporte, 'Parking', 'üÖøÔ∏è', 3),
    (v_cat_transporte, 'Peajes', 'üõ£Ô∏è', 4),
    (v_cat_transporte, 'Metro', 'üöá', 5),
    (v_cat_transporte, 'Autob√∫s', 'üöå', 6),
    (v_cat_transporte, 'Tren', 'üöÑ', 7),
    (v_cat_transporte, 'Taxi', 'üöï', 8),
    (v_cat_transporte, 'VTC (Uber/Cabify)', 'üöñ', 9),
    (v_cat_transporte, 'Bicicleta compartida', 'üö≤', 10),
    (v_cat_transporte, 'Patinete', 'üõ¥', 11),
    (v_cat_transporte, 'Otro transporte', 'üöó', 12);

  -- Lavander√≠a (3 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_lavanderia, 'Lavander√≠a', 'üß∫', 1),
    (v_cat_lavanderia, 'Tintorer√≠a', 'üëî', 2),
    (v_cat_lavanderia, 'Planchado', 'üëö', 3);

  RETURN NEW;
END;
$$;

RESET ROLE;

-- ============================================================================
-- VERIFICACI√ìN
-- ============================================================================
-- Para validar que la funci√≥n actualizada funciona correctamente:
-- 1. Crear un hogar de prueba
-- 2. Verificar que tiene 51 subcategor√≠as (50 originales + 1 Alquiler)
-- 3. Verificar espec√≠ficamente que Hogar > Vivienda > Alquiler existe
