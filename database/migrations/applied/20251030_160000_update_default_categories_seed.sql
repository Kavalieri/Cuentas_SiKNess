-- Actualiza la funci√≥n de seed de categor√≠as para incluir la jerarqu√≠a completa
-- (9 parents + 37 categories + 50 subcategories)
-- Esta funci√≥n se ejecuta autom√°ticamente al crear un nuevo hogar

SET ROLE cuentassik_prod_owner;

-- ============================================================================
-- FUNCI√ìN DE SEED DE CATEGOR√çAS
-- ============================================================================

CREATE OR REPLACE FUNCTION public.create_default_household_categories()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  v_parent_hogar UUID;
  v_parent_suministros UUID;
  v_parent_alimentacion UUID;
  v_parent_transporte UUID;
  v_parent_personal UUID;
  v_parent_estilo_vida UUID;
  v_parent_finanzas UUID;
  v_parent_ingresos_laborales UUID;
  v_parent_otros_ingresos UUID;

  v_cat_vivienda UUID;
  v_cat_menaje UUID;
  v_cat_limpieza UUID;
  v_cat_mantenimiento UUID;
  v_cat_comunidad UUID;
  v_cat_lavanderia UUID;
  v_cat_luz UUID;
  v_cat_agua UUID;
  v_cat_gas UUID;
  v_cat_internet UUID;
  v_cat_telefono UUID;
  v_cat_supermercado UUID;
  v_cat_restaurantes UUID;
  v_cat_transporte UUID;
  v_cat_ropa UUID;
  v_cat_belleza UUID;
  v_cat_salud UUID;
  v_cat_mascotas UUID;
  v_cat_ocio UUID;
  v_cat_deportes UUID;
  v_cat_educacion UUID;
  v_cat_suscripciones UUID;
  v_cat_regalos UUID;
  v_cat_seguros UUID;
  v_cat_impuestos UUID;
  v_cat_varios UUID;
  v_cat_nomina UUID;
  v_cat_freelance UUID;
  v_cat_bonus UUID;
  v_cat_inversiones UUID;
  v_cat_ventas UUID;
  v_cat_devoluciones UUID;
  v_cat_aportacion UUID;
  v_cat_varios_ing UUID;
  v_cat_prestamo_personal UUID;
  v_cat_pago_prestamo UUID;
  v_cat_reembolso UUID;
BEGIN
  -- ============================================================================
  -- CATEGOR√çAS PADRE (9 total)
  -- ============================================================================

  -- GASTOS
  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Hogar', 'üè†', 'expense', 1)
  RETURNING id INTO v_parent_hogar;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Suministros', '‚ö°', 'expense', 2)
  RETURNING id INTO v_parent_suministros;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Alimentaci√≥n', 'üõí', 'expense', 3)
  RETURNING id INTO v_parent_alimentacion;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Transporte', 'üöó', 'expense', 4)
  RETURNING id INTO v_parent_transporte;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Personal', 'üë§', 'expense', 5)
  RETURNING id INTO v_parent_personal;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Estilo de Vida', 'üéØ', 'expense', 6)
  RETURNING id INTO v_parent_estilo_vida;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Finanzas', 'üíº', 'expense', 7)
  RETURNING id INTO v_parent_finanzas;

  -- INGRESOS
  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Ingresos Laborales', 'üí∞', 'income', 1)
  RETURNING id INTO v_parent_ingresos_laborales;

  INSERT INTO category_parents (household_id, name, icon, type, display_order)
  VALUES (NEW.id, 'Otros Ingresos', 'üí∏', 'income', 2)
  RETURNING id INTO v_parent_otros_ingresos;

  -- ============================================================================
  -- CATEGOR√çAS (37 total)
  -- ============================================================================

  -- HOGAR (6 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Vivienda', 'üè†', 'expense', v_parent_hogar, 1)
  RETURNING id INTO v_cat_vivienda;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Menaje', 'üçΩÔ∏è', 'expense', v_parent_hogar, 2)
  RETURNING id INTO v_cat_menaje;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Limpieza', 'üßπ', 'expense', v_parent_hogar, 3)
  RETURNING id INTO v_cat_limpieza;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Mantenimiento', 'üîß', 'expense', v_parent_hogar, 4)
  RETURNING id INTO v_cat_mantenimiento;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Comunidad', 'üèòÔ∏è', 'expense', v_parent_hogar, 5)
  RETURNING id INTO v_cat_comunidad;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Lavander√≠a', 'üß∫', 'expense', v_parent_hogar, 6)
  RETURNING id INTO v_cat_lavanderia;

  -- SUMINISTROS (5 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Luz', 'üí°', 'expense', v_parent_suministros, 1)
  RETURNING id INTO v_cat_luz;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Agua', 'üíß', 'expense', v_parent_suministros, 2)
  RETURNING id INTO v_cat_agua;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Gas/Butano', 'üî•', 'expense', v_parent_suministros, 3)
  RETURNING id INTO v_cat_gas;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Internet', 'üåê', 'expense', v_parent_suministros, 4)
  RETURNING id INTO v_cat_internet;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Tel√©fono', 'üì±', 'expense', v_parent_suministros, 5)
  RETURNING id INTO v_cat_telefono;

  -- ALIMENTACI√ìN (2 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Supermercado', 'üõí', 'expense', v_parent_alimentacion, 1)
  RETURNING id INTO v_cat_supermercado;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Restaurantes', 'üçΩÔ∏è', 'expense', v_parent_alimentacion, 2)
  RETURNING id INTO v_cat_restaurantes;

  -- TRANSPORTE (1 categor√≠a)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Transporte', 'üöó', 'expense', v_parent_transporte, 1)
  RETURNING id INTO v_cat_transporte;

  -- PERSONAL (4 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Ropa', 'üëï', 'expense', v_parent_personal, 1)
  RETURNING id INTO v_cat_ropa;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Belleza', 'üíÑ', 'expense', v_parent_personal, 2)
  RETURNING id INTO v_cat_belleza;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Salud', 'üíä', 'expense', v_parent_personal, 3)
  RETURNING id INTO v_cat_salud;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Mascotas', 'üêæ', 'expense', v_parent_personal, 4)
  RETURNING id INTO v_cat_mascotas;

  -- ESTILO DE VIDA (5 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Ocio', 'üé¨', 'expense', v_parent_estilo_vida, 1)
  RETURNING id INTO v_cat_ocio;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Deportes', '‚öΩ', 'expense', v_parent_estilo_vida, 2)
  RETURNING id INTO v_cat_deportes;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Educaci√≥n', 'üìö', 'expense', v_parent_estilo_vida, 3)
  RETURNING id INTO v_cat_educacion;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Suscripciones', 'üì∫', 'expense', v_parent_estilo_vida, 4)
  RETURNING id INTO v_cat_suscripciones;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Regalos', 'üéÅ', 'expense', v_parent_estilo_vida, 5)
  RETURNING id INTO v_cat_regalos;

  -- FINANZAS (5 categor√≠as, incluyendo las de cr√©dito/deuda)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Seguros', 'üõ°Ô∏è', 'expense', v_parent_finanzas, 1)
  RETURNING id INTO v_cat_seguros;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Impuestos', 'üíµ', 'expense', v_parent_finanzas, 2)
  RETURNING id INTO v_cat_impuestos;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Varios', 'üìã', 'expense', v_parent_finanzas, 3)
  RETURNING id INTO v_cat_varios;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Pr√©stamo Personal', 'üí∞', 'expense', v_parent_finanzas, 4)
  RETURNING id INTO v_cat_prestamo_personal;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Reembolso Saldo a Favor', '‚Ü©Ô∏è', 'expense', v_parent_finanzas, 5)
  RETURNING id INTO v_cat_reembolso;

  -- INGRESOS LABORALES (3 categor√≠as)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'N√≥mina', 'üí∞', 'income', v_parent_ingresos_laborales, 1)
  RETURNING id INTO v_cat_nomina;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Freelance', 'üíº', 'income', v_parent_ingresos_laborales, 2)
  RETURNING id INTO v_cat_freelance;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Bonus', 'üéÅ', 'income', v_parent_ingresos_laborales, 3)
  RETURNING id INTO v_cat_bonus;

  -- OTROS INGRESOS (6 categor√≠as, incluyendo Pago Pr√©stamo)
  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Inversiones', 'üìà', 'income', v_parent_otros_ingresos, 1)
  RETURNING id INTO v_cat_inversiones;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Ventas', 'üè∑Ô∏è', 'income', v_parent_otros_ingresos, 2)
  RETURNING id INTO v_cat_ventas;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Devoluciones', 'üîÑ', 'income', v_parent_otros_ingresos, 3)
  RETURNING id INTO v_cat_devoluciones;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Aportaci√≥n Cuenta Conjunta', 'üè¶', 'income', v_parent_otros_ingresos, 4)
  RETURNING id INTO v_cat_aportacion;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Varios', 'üìã', 'income', v_parent_otros_ingresos, 5)
  RETURNING id INTO v_cat_varios_ing;

  INSERT INTO categories (household_id, name, icon, type, parent_id, display_order)
  VALUES (NEW.id, 'Pago Pr√©stamo', 'üí≥', 'income', v_parent_otros_ingresos, 6)
  RETURNING id INTO v_cat_pago_prestamo;

  -- ============================================================================
  -- SUBCATEGOR√çAS (50 total - las m√°s comunes)
  -- ============================================================================

  -- Supermercado (7 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_supermercado, 'Mercadona', 'üõí', 1),
    (v_cat_supermercado, 'Lidl', 'üõí', 2),
    (v_cat_supermercado, 'Carrefour', 'üõí', 3),
    (v_cat_supermercado, 'D√≠a', 'üõí', 4),
    (v_cat_supermercado, 'Alcampo', 'üõí', 5),
    (v_cat_supermercado, 'Eroski', 'üõí', 6),
    (v_cat_supermercado, 'Otro supermercado', 'üõí', 7);

  -- Restaurantes (6 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_restaurantes, 'Fast Food', 'üçî', 1),
    (v_cat_restaurantes, 'Cafeter√≠as', '‚òï', 2),
    (v_cat_restaurantes, 'Restaurante Casual', 'üçΩÔ∏è', 3),
    (v_cat_restaurantes, 'Restaurante Medio', 'üçΩÔ∏è', 4),
    (v_cat_restaurantes, 'Delivery', 'üõµ', 5),
    (v_cat_restaurantes, 'Otro restaurante', 'üçΩÔ∏è', 6);

  -- Luz (5 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_luz, 'Iberdrola', 'üí°', 1),
    (v_cat_luz, 'Endesa', 'üí°', 2),
    (v_cat_luz, 'Naturgy', 'üí°', 3),
    (v_cat_luz, 'Repsol', 'üí°', 4),
    (v_cat_luz, 'Otra compa√±√≠a', 'üí°', 5);

  -- Agua (3 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_agua, 'Canal de Isabel II', 'üíß', 1),
    (v_cat_agua, 'Aguas Municipales', 'üíß', 2),
    (v_cat_agua, 'Otra compa√±√≠a', 'üíß', 3);

  -- Gas/Butano (3 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_gas, 'Naturgy', 'üî•', 1),
    (v_cat_gas, 'Repsol Butano', 'üî•', 2),
    (v_cat_gas, 'Otra compa√±√≠a', 'üî•', 3);

  -- Internet (6 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_internet, 'Vodafone', 'üåê', 1),
    (v_cat_internet, 'Movistar', 'üåê', 2),
    (v_cat_internet, 'Orange', 'üåê', 3),
    (v_cat_internet, 'Yoigo', 'üåê', 4),
    (v_cat_internet, 'M√°sM√≥vil', 'üåê', 5),
    (v_cat_internet, 'Otra operadora', 'üåê', 6);

  -- Tel√©fono (5 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_telefono, 'Vodafone', 'üì±', 1),
    (v_cat_telefono, 'Movistar', 'üì±', 2),
    (v_cat_telefono, 'Orange', 'üì±', 3),
    (v_cat_telefono, 'Yoigo', 'üì±', 4),
    (v_cat_telefono, 'Otra operadora', 'üì±', 5);

  -- Transporte (12 subcategor√≠as - la m√°s granular)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_transporte, 'Gasolina', '‚õΩ', 1),
    (v_cat_transporte, 'Di√©sel', '‚õΩ', 2),
    (v_cat_transporte, 'Parking', 'üÖøÔ∏è', 3),
    (v_cat_transporte, 'Peajes', 'üõ£Ô∏è', 4),
    (v_cat_transporte, 'Metro', 'üöá', 5),
    (v_cat_transporte, 'Autob√∫s', 'üöå', 6),
    (v_cat_transporte, 'Tren', 'üöÑ', 7),
    (v_cat_transporte, 'Taxi', 'üöï', 8),
    (v_cat_transporte, 'VTC (Uber/Cabify)', 'üöñ', 9),
    (v_cat_transporte, 'Bicicleta compartida', 'üö≤', 10),
    (v_cat_transporte, 'Patinete', 'üõ¥', 11),
    (v_cat_transporte, 'Otro transporte', 'üöó', 12);

  -- Lavander√≠a (3 subcategor√≠as)
  INSERT INTO subcategories (category_id, name, icon, display_order) VALUES
    (v_cat_lavanderia, 'Lavander√≠a', 'üß∫', 1),
    (v_cat_lavanderia, 'Tintorer√≠a', 'üëî', 2),
    (v_cat_lavanderia, 'Planchado', 'üëö', 3);

  RETURN NEW;
END;
$$;

-- ============================================================================
-- TRIGGER
-- ============================================================================

-- Asegurar que el trigger existe y apunta a la funci√≥n actualizada
DROP TRIGGER IF EXISTS trigger_create_default_categories ON public.households;
CREATE TRIGGER trigger_create_default_categories
AFTER INSERT ON public.households
FOR EACH ROW
EXECUTE FUNCTION public.create_default_household_categories();

RESET ROLE;

-- ============================================================================
-- VERIFICACI√ìN
-- ============================================================================
-- La funci√≥n ser√° ejecutada autom√°ticamente cuando se cree un nuevo hogar.
-- Para verificar, crear un hogar de prueba y comprobar:
-- SELECT COUNT(*) FROM category_parents WHERE household_id = '<nuevo_household_id>'; -- debe ser 9
-- SELECT COUNT(*) FROM categories WHERE household_id = '<nuevo_household_id>'; -- debe ser 37
-- SELECT COUNT(*) FROM subcategories WHERE category_id IN (SELECT id FROM categories WHERE household_id = '<nuevo_household_id>'); -- debe ser 50
